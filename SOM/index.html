<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>O.B.I.T. — ノベル＋ワープ＆軌道カメラ＆HUD（Prev/Next＋異星語CANVAS）</title>
<style>
  html, body { margin: 0; height: 100%; background: #000; color: #fff;
    font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Yu Gothic", monospace; }
  #app { position: relative; height: 100%; overflow: hidden; }
  canvas { display: block; }

  /* Three.js（宇宙） / 画像背景（地上） */
  #threeLayer { position: absolute; inset:0; }
  #imageLayer { position:absolute; inset:0; display:none; background:#000 center/cover no-repeat; }
  #imageLayer::after { content:""; position:absolute; inset:0;
    background: radial-gradient(ellipse at 50% 120%, rgba(0,0,0,.0), rgba(0,0,0,.55) 60%, rgba(0,0,0,.9) 100%); }

  /* ノベルUI（下部） */
  .panel { position:absolute; left:0; right:0; bottom:0; padding:18px 16px 24px;
    background:linear-gradient(180deg,#0000,#0006 40%,#0009);
    z-index:10; }
  .textbox {
    max-width:min(980px,92vw); margin:0 auto; padding:14px 18px;
    border:1px solid rgba(255,255,255,.16); border-radius:14px;
    background:rgba(11,13,18,.35); backdrop-filter: blur(8px);
    box-shadow:0 8px 24px rgba(0,0,0,.25);
    font-size:16px; line-height:1.9;
    display:grid; grid-template-rows: 1.4em auto auto; row-gap:10px; align-items:start;
  }
  .speaker{ opacity:.85; font-size:13px; line-height:1.4em; min-height:1.4em; }
  #text{ white-space:pre-wrap; word-break:break-word; }
  .controls{ display:flex; gap:14px; justify-content:flex-end; }
  .btn{
    pointer-events:auto; border:1px solid #2a2a2a; background:#101318;
    padding:14px 22px; border-radius:14px; color:#fff;
    font-weight:700; letter-spacing:.02em; cursor:pointer; transition:.18s;
    font-size:18px; min-height:48px;
  }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 6px 16px #0006; }

  /* HUD（アラート等） */
  #hud { position:absolute; inset:0; z-index:8; pointer-events:none; }

  /* 通信（異星語の可視化） */
  #comm { position:absolute; inset:8% 8% auto 8%; height:28%;
    border:1px solid rgba(0,255,200,.35); border-radius:12px; background: rgba(0,30,30,.55);
    display:none; overflow:hidden; backdrop-filter: blur(2px); z-index:9; }
  #commCanvas { width:100%; height:60%; display:block;
    background: repeating-linear-gradient(0deg, rgba(0,255,200,.08), rgba(0,255,200,.08) 2px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 4px); }
  #commText { padding:6px 10px; font-family: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;
    font-size:13px; color:#b9ffe9; text-shadow:0 0 6px rgba(0,255,200,.6); white-space:pre-wrap; line-height:1.5; }

  /* フラッシュ */
  .flash { position:absolute; inset:0; background: radial-gradient(closest-side, rgba(255,255,255,.85), rgba(255,255,255,0) 65%);
           opacity:0; pointer-events:none; transition:opacity 180ms ease; z-index:9; }
  .flash.on { opacity:1; }

  /* 上部ミニUI（任意） */
  .ui { position: absolute; inset:12px 12px auto 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
        background: rgba(0,0,0,.32); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:6px 10px; backdrop-filter: blur(4px); font-size:12px; z-index:10;}
  .chip { padding:3px 8px; border:1px solid rgba(255,255,255,.2); border-radius:999px; opacity:.9; }
</style>

<!-- Three.js -->
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
<div id="app">
  <!-- 宇宙（Three.js） -->
  <div id="threeLayer"></div>
  <!-- 地上（任意画像） -->
  <div id="imageLayer"></div>

  <!-- 通信（異星語のみ可視化） -->
  <div id="comm">
    <canvas id="commCanvas"></canvas>
    <div id="commText"></div>
  </div>

  <!-- HUD（アラート等） -->
  <canvas id="hud" width="1920" height="1080"></canvas>

  <!-- フラッシュ -->
  <div class="flash" id="fxFlash"></div>

  <!-- ちょいUI（任意の手動切替） -->
  <div class="ui">
    <span class="chip" id="sceneChip">Scene: --</span>
    <button class="btn" id="btnRecenter">視点リセット</button>
  </div>

  <!-- ノベルUI（Prev/Next） -->
  <div class="panel">
    <div class="textbox" id="novelBox">
      <div class="speaker" id="name"></div>
      <div id="text"></div>
      <div class="controls">
        <button class="btn" id="prevBtn">◀ 戻る</button>
        <button class="btn" id="nextBtn">次へ ▶</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= 背景（地上用） ========= */
const imageLayer = document.getElementById('imageLayer');
function setCenterBG(url){ imageLayer.style.backgroundImage = `url("${url}")`; }

/* ========= Three.js（宇宙シーン） ========= */
const threeLayer = document.getElementById('threeLayer');
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
threeLayer.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(55, window.innerWidth/window.innerHeight, 0.1, 4000);
camera.position.set(0, 0, 12); // 初期遠目 → ワープで寄せる

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.dampingFactor = 0.06; controls.minDistance = 3.2; controls.maxDistance = 60;

const ambient = new THREE.AmbientLight(0xffffff, 0.55); scene.add(ambient);
const sun = new THREE.DirectionalLight(0xffffff, 1.2); sun.position.set(10,5,8); scene.add(sun);

const R = 3;
const loader = new THREE.TextureLoader(); loader.setCrossOrigin('anonymous');
const texDay   = loader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg');
const texNight = loader.load('https://threejs.org/examples/textures/planets/earth_lights_2048.png');
const texSpec  = loader.load('https://threejs.org/examples/textures/planets/earth_specular_2048.jpg');
const texCloud = loader.load('https://threejs.org/examples/textures/planets/earth_clouds_1024.png');
[texDay, texNight, texSpec, texCloud].forEach(t => { t.anisotropy = Math.min(8, renderer.capabilities.getMaxAnisotropy()); });

const earth = new THREE.Mesh(new THREE.SphereGeometry(R, 96, 96), new THREE.MeshPhongMaterial({
  map:texDay, specularMap:texSpec, specular:new THREE.Color(0x333333), shininess:12,
  emissiveMap:texNight, emissive:new THREE.Color(0x222222), emissiveIntensity:1.0
}));
scene.add(earth);

const grid = new THREE.LineSegments(
  new THREE.WireframeGeometry(new THREE.SphereGeometry(R*1.001, 32, 22)),
  new THREE.LineBasicMaterial({ color:0x2f4f80, transparent:true, opacity:0.35 })
); scene.add(grid);

/* 雲を“もう少し高く” */
const clouds = new THREE.Mesh(
  new THREE.SphereGeometry(R*1.012, 96, 96),
  new THREE.MeshLambertMaterial({ map:texCloud, transparent:true, opacity:0.9, depthWrite:false })
); scene.add(clouds);

const atmosphere = new THREE.Mesh(new THREE.SphereGeometry(R*1.02, 64, 64),
  new THREE.MeshBasicMaterial({ color:0x4aa3ff, transparent:true, opacity:0.12, blending:THREE.AdditiveBlending, side:THREE.BackSide, depthWrite:false })
); scene.add(atmosphere);

/* 星（背景） */
const starGeo = new THREE.BufferGeometry();
const STAR_N = 2000, starPos = new Float32Array(STAR_N*3);
for (let i=0;i<STAR_N;i++){
  const r = 1000 * Math.cbrt(Math.random()), th = Math.random()*Math.PI*2, ph = Math.acos(2*Math.random()-1);
  starPos[i*3+0] = r*Math.sin(ph)*Math.cos(th);
  starPos[i*3+1] = r*Math.sin(ph)*Math.sin(th);
  starPos[i*3+2] = r*Math.cos(ph);
}
starGeo.setAttribute('position', new THREE.BufferAttribute(starPos,3));
const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({ color:0x88aaff, size:1.0, sizeAttenuation:false, opacity:.9, transparent:true })); scene.add(stars);
const nebula = new THREE.Mesh(new THREE.PlaneGeometry(3000,1200,1,1), new THREE.MeshBasicMaterial({ color:0x1f2b50, transparent:true, opacity:0.15 }));
nebula.rotation.x = -Math.PI/2.6; nebula.position.y=-600; scene.add(nebula);

/* ========= シーン切替 ========= */
function setSceneSpace(){
  threeLayer.style.display = 'block';
  imageLayer.style.display = 'none';
  renderer.setClearColor(0x000000, 0);
  earth.visible = true; clouds.visible = true; atmosphere.visible = true; stars.visible = true; nebula.visible = true; grid.visible = true;
}
function setSceneStars(){
  threeLayer.style.display = 'block';
  imageLayer.style.display = 'none';
  renderer.setClearColor(0x000000, 1);
  earth.visible = false; clouds.visible = false; atmosphere.visible = false; nebula.visible = false; grid.visible = false;
  stars.visible = true;
}
function setSceneBlack(){
  threeLayer.style.display = 'block';
  imageLayer.style.display = 'none';
  renderer.setClearColor(0x000000, 1);
  earth.visible = false; clouds.visible = false; atmosphere.visible = false; stars.visible = false; nebula.visible = false; grid.visible = false;
}
function setSceneCenterWithBG(bgUrl){
  threeLayer.style.display = 'none';
  imageLayer.style.display = 'block';
  if(bgUrl) setCenterBG(bgUrl);
}
function applyScene(line){
  if(!line.scene) return;
  if(line.scene === 'space')  setSceneSpace();
  if(line.scene === 'stars')  setSceneStars();
  if(line.scene === 'black')  setSceneBlack();
  if(line.scene === 'center') setSceneCenterWithBG(line.bg);
  sceneChip.textContent = "Scene: " + line.scene + (line.bg ? ` (${line.bg})` : "");
}

/* ========= HUD（アラート） ========= */
const hud = document.getElementById('hud');
const hctx = hud.getContext('2d');
function resizeHUD(){ hud.width = innerWidth; hud.height = innerHeight; }
resizeHUD();
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  if(r>w/2)r=w/2; if(r>h/2)r=h/2; ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.arcTo(x+w,y, x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill)ctx.fill(); if(stroke)ctx.stroke();
}
function wrapText(ctx,text,x,y,maxW,lineH){ const words=text.split(/(\s+)/); let line=''; for(let n=0;n<words.length;n++){ const t=line+words[n], w=ctx.measureText(t).width;
  if(w>maxW && n>0){ ctx.fillText(line,x,y); line=words[n]; y+=lineH; } else line=t; } ctx.fillText(line,x,y); }
function showAlert(text){
  const W=hud.width, H=hud.height; const boxW=Math.min(W*0.86,720), boxH=90, x=(W-boxW)/2, y=30;
  let a=0, phase='in', start=performance.now(); const hold=900, fade=260;
  (function draw(now){
    const dt=now-start; if(phase==='in'){ a=Math.min(1,dt/180); if(dt>=180){phase='hold'; start=now;} }
    else if(phase==='hold'){ a=1; if(dt>=hold){ phase='out'; start=now;} }
    else { a=1-Math.min(1,dt/fade); if(a<=0){ hctx.clearRect(0,0,W,H); return; } }
    hctx.clearRect(0,0,W,H); hctx.save(); hctx.globalAlpha=a;
    hctx.fillStyle='rgba(255,0,0,0.18)'; hctx.fillRect(x-8,y-8,boxW+16,boxH+16);
    hctx.fillStyle='rgba(35,0,0,0.85)'; hctx.strokeStyle='rgba(255,80,80,0.9)'; hctx.lineWidth=2; roundRect(hctx,x,y,boxW,boxH,10,true,true);
    hctx.fillStyle='rgba(255,60,60,0.9)'; hctx.fillRect(x,y,6,boxH);
    hctx.fillStyle='#ffcccc'; hctx.font='700 18px system-ui, -apple-system, "Yu Gothic", sans-serif'; hctx.fillText('ALERT', x+16, y+28);
    hctx.font='14px system-ui, -apple-system, "Yu Gothic", sans-serif'; wrapText(hctx, text, x+16, y+54, boxW-32, 20);
    hctx.strokeStyle='rgba(255,80,80,0.6)'; for(let i=0;i<3;i++){ const yy=y+20+Math.random()*50; hctx.beginPath(); hctx.moveTo(x+10+Math.random()*20,yy); hctx.lineTo(x+boxW-10-Math.random()*20,yy); hctx.stroke(); }
    hctx.restore(); requestAnimationFrame(draw);
  })(performance.now());
}

/* ========= 通信（異星語） ========= */
const commBox = document.getElementById('comm');
const commCanvas = document.getElementById('commCanvas');
const commText = document.getElementById('commText');
const cctx = commCanvas.getContext('2d');
let commOn=false, commRAF=null;
function sizeComm(){ commCanvas.width = commBox.clientWidth; commCanvas.height = Math.floor(commBox.clientHeight*0.6); }
sizeComm();
function drawComm(){
  if(!commOn) return;
  const now = performance.now(); const w=commCanvas.width, h=commCanvas.height;
  cctx.clearRect(0,0,w,h);
  for(let y=0;y<h;y+=2){ cctx.fillStyle='rgba(0,255,200,0.05)'; cctx.fillRect(0,y,w,1); }
  cctx.beginPath(); const base=h*0.5;
  for(let x=0;x<w;x++){
    const n = Math.sin((x*0.02)+now*0.005)*18 + Math.sin((x*0.07)+now*0.0018)*8 + (Math.random()-0.5)*6;
    const y = base + n; if(x===0) cctx.moveTo(x,y); else cctx.lineTo(x,y);
  }
  cctx.strokeStyle='rgba(120,255,220,0.85)'; cctx.lineWidth=2; cctx.stroke();
  for(let i=0;i<60;i++){ cctx.fillStyle='rgba(120,255,220,0.22)'; cctx.fillRect(Math.random()*w, Math.random()*h, 1,1); }
  commRAF = requestAnimationFrame(drawComm);
}
let audioCtx=null, beepOsc=null, beepGain=null, beepTimer=null;
function audioInit(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
function beepStart(){ audioInit(); beepOsc=audioCtx.createOscillator(); beepGain=audioCtx.createGain();
  beepOsc.type='triangle'; beepOsc.frequency.value=980; beepGain.gain.value=0.0001;
  beepOsc.connect(beepGain).connect(audioCtx.destination); beepOsc.start();
  let v=0.0001; beepTimer=setInterval(()=>{ v=0.03+Math.random()*0.02; beepGain.gain.setTargetAtTime(v,audioCtx.currentTime,0.02);
    beepOsc.frequency.setTargetAtTime(780+Math.random()*620,audioCtx.currentTime,0.03); }, 90);
}
function beepStop(){ if(beepTimer)clearInterval(beepTimer); beepTimer=null; try{beepOsc&&beepOsc.stop()}catch{}; beepGain&&beepGain.disconnect(); beepOsc&&beepOsc.disconnect(); beepOsc=beepGain=null; }
function commShow(text){ // textは異星語のみを流す
  commText.textContent = text || "";
  if(!commOn){ commOn=true; commBox.style.display='block'; drawComm(); beepStart(); }
}
function commHide(){ commOn=false; commBox.style.display='none'; if(commRAF)cancelAnimationFrame(commRAF); commRAF=null; beepStop(); }

/* ========= フラッシュ ========= */
const elFlash = document.getElementById('fxFlash');
function flash(){ elFlash.classList.add('on'); setTimeout(()=>elFlash.classList.remove('on'), 160); }

/* ========= カメラ制御（球座標）＆ワープ ========= */
function easeInOutQuad(t){ return t<0.5 ? 2*t*t : -1+(4-2*t)*t; }
function tween(from,to,dur,onUpdate,onDone,ease=easeInOutQuad){
  const start = performance.now();
  function step(now){
    const p=Math.min(1,(now-start)/dur), e=ease(p);
    const v = Array.isArray(from) ? from.map((f,i)=>f+(to[i]-f)*e) : from+(to-from)*e;
    onUpdate(v,p); if(p<1) requestAnimationFrame(step); else onDone&&onDone();
  } requestAnimationFrame(step);
}
function sphToVec(radius, latDeg, lonDeg){
  const lat = THREE.MathUtils.degToRad(latDeg), lon=THREE.MathUtils.degToRad(lonDeg);
  return new THREE.Vector3(radius*Math.cos(lat)*Math.cos(lon), radius*Math.sin(lat), radius*Math.cos(lat)*Math.sin(lon));
}
function moveCameraTo(radius, lat=10, lon=0, dur=900){
  const from=[camera.position.x, camera.position.y, camera.position.z];
  const toV=sphToVec(radius,lat,lon), to=[toV.x,toV.y,toV.z];
  tween(from,to,dur,(v)=>{ camera.position.set(v[0],v[1],v[2]); camera.lookAt(0,0,0); });
}
function focusEarthRadius(radius=R+3.6, dur=900){
  const dir=camera.position.clone().normalize(); moveCameraTo(radius,
    THREE.MathUtils.radToDeg(Math.asin(dir.y)),
    THREE.MathUtils.radToDeg(Math.atan2(dir.z,dir.x)),
    dur);
}
function warp(){
  starStreaks(700);
  const f0=camera.fov; tween(f0,85,260,(v)=>{ camera.fov=v; camera.updateProjectionMatrix(); }, ()=> {
    tween(85,55,340,(v)=>{ camera.fov=v; camera.updateProjectionMatrix(); });
  });
}
function starStreaks(total=600){
  const W=hud.width, H=hud.height; const lines=[];
  for(let i=0;i<40;i++) lines.push({x:Math.random()*W,y:Math.random()*H,len:120+Math.random()*240,w:1+Math.random()*3,a:1,vx:(Math.random()-.5)*2,vy:(Math.random()-.5)*2});
  let t=0; (function tick(){
    t+=16; hctx.clearRect(0,0,W,H); hctx.save(); hctx.globalCompositeOperation='lighter';
    for(const L of lines){ hctx.globalAlpha=L.a; hctx.strokeStyle='#bcd3ff'; hctx.lineWidth=L.w; hctx.beginPath(); hctx.moveTo(L.x,L.y); hctx.lineTo(L.x+L.len*0.9,L.y); hctx.stroke();
      L.x+=L.vx*8; L.y+=L.vy*4; L.a*=0.96; }
    hctx.restore(); if(t<total) requestAnimationFrame(tick); else hctx.clearRect(0,0,W,H);
  })();
}

/* ========= ノベルUI ========= */
const elName = document.getElementById('name');
const elText = document.getElementById('text');
const elBox  = document.getElementById('novelBox');
const prevBtn= document.getElementById('prevBtn');
const nextBtn= document.getElementById('nextBtn');
const sceneChip=document.getElementById('sceneChip');
const btnRecenter=document.getElementById('btnRecenter');

/* ========= スクリプト ========= */
const SCRIPT = [
  { scene:"stars", t:"銀河で最も賑わう首都星から、数万光年も離れた片隅の星《地球》。" },
  { scene:"space", t:"その軌道を回る人工衛星のそばに、母星最大級の宇宙船が、超光速回廊ワープから吐き出されるように、忽然と姿を現した。",
    fx:"warp", cam:{ radius:R+6.8, lat:8, lon:25 } },

  { t:"　操縦席には、一体の宇宙人が腰を下ろしていた。" },
  { t:"　彼は母星Keplerケプラーにおいて、十万年を生き抜いたとはいえ、まだ“若者”にすぎなかった。" },
  { t:"　父親は星籍登録官サーベイヤーとしての役目を果たし終え、ほどなくして神の元へと召された。遺産に残されたのは、登録だけされ放置された辺境の惑星だった。" },
  { t:"　――青と白の雲が渦巻く球体が、全面スクリーンに映し出されていた。" },
  { t:"　若い宇宙人は、水底のナマズを思わせる顎髭を指先でなぞり、小さくつぶやいた。" },
  { s:"若い宇宙人", t:"「……これが父が航路調査の途中で見つけ、星籍登録官の特権で資産にしたという星か。けれど、こんな不便な場所、誰の役にも立たない。」" },
  { t:"　小型端末の画面を見つめ、ため息をつく。" },
  { s:"若い宇宙人", t:"「どうしたものか。このまま宇宙固定資産税コズミック・タックスがかかるくらいなら、いっそのこと星籍を抹消してしまおうか」" },
  { t:"　その手は、惑星破砕兵器のスイッチへ向かった。" },
  { t:"　だが押す前に「銀河交易規定星間ルール」を一応満たすため、形式的な信号を発信した――。", fx:"flash" },

  { scene:"black", t:"　ーーそのころ、地球の衛星運用センター。" },

  { scene:"center", bg:"center.png", t:"　夜勤に入っていた疲れ気味の新人研究員が、あくびをかみ殺していた。" },
  { t:"　机には片付け忘れたラーメン容器と冷めたコーヒー。人工衛星に組み込まれた新型防衛AIのテスト稼働を監視しながら、重たいまぶたをこすっていた。" },
  { t:"　AIの名はO.B.I.T.オービット（Orbital Behavior Intercept & Termination）軌道行動傍受・無力化システム。" },
  { t:"　宇宙空間を通過する弾道飛翔体を捕捉し、危険とみなすと、無力化計画（Trajectory Planning：迎撃軌道を計算して行動する仕組み）を自律的に立案・実行する。" },
  { t:"　テスト開始以来、大きな問題は一度もなく、今日も無事に終わるはず――そう思い込んでいたため、センターには気の緩んだ空気が漂っていた。" },

  { scene:"center", bg:"center1.png", t:"《未識別軌道体接近：脅威レベルHigh》", fx:"alert" },
  { t:"　すぐ近くの宙域から発せられた微弱な電波をとらえ、O.B.I.T.が作動した。" },
  { t:"物体検知オブジェクト・ディテクションシステムが反応し、アラートを鳴らしたのだ。" },
  { t:"　O.B.I.T.は、認識モジュールコグニティブ・レイヤーに古い観測データを学習させていた。" },
  { t:"　1960年代から続く SETI計画（Search for Extra Terrestrial Intelligence）地球外知的生命体探査。その膨大な電波アーカイブの中には、当時“未知のキャリア波”として記録された“異星船のテレメトリ信号断片”が紛れていた。" },
  { t:"　その結果――O.B.I.T.は深い中間層で形成された特徴表現の活性パターンから「艦影ケプラー星系のシップ」を見抜いていた。" },
  { t:"　さらに、ディープラーニング特有の「説明不可能性ブラックボックス」によって、人類が知るよしもなかったが、“異星語ケプラー語”を話せる状態にあったのだ" },
  { t:"　O.B.I.T.は、人類文明が保有する兵器体系では対処不能と見抜くとすぐに、偽装した銀河管理局の公式メッセージを送信した。" },

  { scene:"space", fx:"comm_on",
    commText:"[LINK-UP] ∴∵‥ SIGNAL SYNC ... OK\n[PROTO] KEPLERIAN / CONTROL-PLANE / HANDSHAKE\n[ENC] QPSK/LDPC ... LOCK\n[NOTE] TRANSLATION LAYER BOOTSTRAP ..." },
  { fx:"comm",
    commText:"Ϟ≒ΔЖ∷⋈Ω∵†Ψ\n≡ξ∮Φ∻¤Λ⋄\n⋆≜⊗Ж∴⟊≠\nϟ∺ΛΩ≑Ж✧∵Ψ\n⋀Φ∵Ψ¤Ω⋈\nЖΞ≃ϞΨξΩ⋄\n⊹∴ϟΞ¤Λ⋈∺\nЖΨΦ⊗Ξ⋄" },
  { t:"メッセージの内容は以下であった「こちらは銀河管理局の管制官。当惑星は検疫下。高病原性微生物を封じ込め中。現時点の干渉は銀河拡散リスクを高めるため、あらゆる行動を控えられたい。」" },

  { t:"　若い宇宙人はそれを受信すると、管制官の警告を真に受けて深くうなずいた。そして、静かにスイッチから手を離す。" },
  { s:"若い宇宙人", t:"「検疫下の惑星など、わざわざ危険を冒す必要はない。……まあ、来年にでもまた来るか」" },
  { t:"　彼にとっての「来年」は地球歴で二千年後のこと。彼はリスクを避け、静かに退去した。" },

  { fx:"comm_off" },

  { scene:"center", t:"　研究員はコーヒーをすすりながらモニターを眺めた。" },
  { t:"　画面には「Ϟ≒ΔЖ∷⋈Ω∵†Ψ…」という出鱈目な通信ログが残っている。" },
  { t:"　レーダー記録トラックに残っていたのは、直径数センチ級の隕石片と思われるエコーにすぎなかった。大気圏に突入すれば、摩擦熱で燃え尽きて消える程度のものだ。" },
  { s:"研究員", t:"「また石ころ隕石片をミサイルと間違えたな。次の再学習モデルアップデートで直してもらおう」" },
  { t:"　研究員は、誤検知偽陽性として片付けた。" }
];

/* ========= ノベル進行 ========= */
let idx=0;
function setName(name){ elName.textContent = name ? name : ""; elName.style.visibility = name ? "visible" : "hidden"; }
function doFX(line){
  if(line.fx === 'flash') flash();
  if(line.fx === 'warp'){ warp(); }
  if(line.fx === 'alert'){ const txt = line.t.replace(/^[《]/,'').replace(/[》]$/,''); showAlert(txt); }
  if(line.fx === 'comm_on'){ commShow(line.commText||""); }
  if(line.fx === 'comm'){ if(line.commText) commShow(line.commText); }
  if(line.fx === 'comm_off'){ commHide(); }
}
function applyCam(line){
  if(!line.cam) return; // A→B / C→D は cam を付けない＝カメラ固定
  const { radius, lat=10, lon=0 } = line.cam;
  moveCameraTo(radius, lat, lon, 900);
}
function showLine(i){
  if(i<0 || i>=SCRIPT.length) return;
  const line = SCRIPT[i];
  applyScene(line);
  doFX(line);
  applyCam(line);
  setName(line.s || null);
  elText.textContent = line.t || "";
}
function nextLine(){ idx = Math.min(SCRIPT.length-1, idx+1); showLine(idx); }
function prevLine(){ idx = Math.max(0, idx-1); showLine(idx); }

/* ========= イベント ========= */
nextBtn.addEventListener('click', nextLine);
prevBtn.addEventListener('click', prevLine);
btnRecenter.addEventListener('click', ()=> focusEarthRadius(R+3.8, 800));
document.addEventListener('keydown', (e)=>{
  if(e.key === 'ArrowRight' || e.key === ' ') nextLine();
  if(e.key === 'ArrowLeft') prevLine();
});

/* ========= リサイズ＆アニメ ========= */
addEventListener('resize', ()=>{
  camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
  resizeHUD(); sizeComm();
});
function animate(){
  requestAnimationFrame(animate);
  const rot=0.0005; earth.rotation.y+=rot; grid.rotation.y=earth.rotation.y; clouds.rotation.y+=rot*1.4;
  stars.rotation.y+=0.00005; nebula.rotation.z+=0.00002;
  controls.update(); renderer.render(scene, camera);
}
animate();

/* ========= スタート ========= */
(function resetStory(){ idx=0; showLine(idx); })();
</script>
</body>
</html>
